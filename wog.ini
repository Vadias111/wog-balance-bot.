import requests
import logging
import os

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–µ–ø–µ—Ä—å –º—ã –±–µ—Ä–µ–º –∫–ª—é—á–∏ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub, –∞ –Ω–µ –ø–∏—à–µ–º –∏—Ö –≤ –∫–æ–¥–µ
WOG_API_KEY = os.environ.get('WOG_API_KEY')
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID')

# –ü–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–¥–µ—Å—å –∏–ª–∏ —Ç–æ–∂–µ –≤—ã–Ω–µ—Å—Ç–∏ –≤ —Å–µ–∫—Ä–µ—Ç—ã
BALANCE_THRESHOLD = 1000.0
# --- –ö–û–ù–ï–¶ –ù–ê–°–¢–†–û–ï–ö ---

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É."""
    if not all([WOG_API_KEY, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID]):
        logging.error("–û–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (WOG_API_KEY, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID) –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")
        return

    WOG_API_URL = f"https://api-fuelcards.wog.ua/{WOG_API_KEY}"
    TELEGRAM_API_URL = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"

    logging.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ WOG...")
    headers = {'Content-Type': 'application/json'}
    data = {"version": "1.0"}

    try:
        response = requests.post(WOG_API_URL, headers=headers, json=data, params={'Action': 'WalletsRemains'})
        response.raise_for_status() # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ HTTP-–æ—à–∏–±–∫–∏

        response_data = response.json()
        if response_data.get("status") == 0 and "remains" in response_data:
            uah_wallet = next((wallet for wallet in response_data["remains"] if wallet.get("GoodsName") == "–ì—Ä–Ω"), None)

            if uah_wallet:
                current_balance = float(uah_wallet.get("Value", 0.0))
                logging.info(f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {current_balance:.2f} –≥—Ä–Ω.")

                if current_balance < BALANCE_THRESHOLD:
                    message = (
                        f"üö® *–í–Ω–∏–º–∞–Ω–∏–µ!* üö®\n\n"
                        f"–ë–∞–ª–∞–Ω—Å –Ω–∞ —Å—á–µ—Ç—É WOG —É–ø–∞–ª –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞.\n\n"
                        f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: *{current_balance:.2f} –≥—Ä–Ω.*\n"
                        f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥: *{BALANCE_THRESHOLD:.2f} –≥—Ä–Ω.*\n\n"
                        f"–ü–æ—Ä–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç!"
                    )
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
                    payload = {'chat_id': TELEGRAM_CHAT_ID, 'text': message, 'parse_mode': 'Markdown'}
                    requests.post(TELEGRAM_API_URL, data=payload)
                    logging.info("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
                else:
                    logging.info("–ë–∞–ª–∞–Ω—Å –≤ –Ω–æ—Ä–º–µ.")
            else:
                logging.warning("–ì—Ä–∏–≤–Ω–µ–≤—ã–π –∫–æ—à–µ–ª–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ API.")
        else:
            logging.error(f"API WOG –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É: {response_data.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}")

    except requests.exceptions.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ WOG: {e}")
    except Exception as e:
        logging.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()
